<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Predictor</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: auto;
            background: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        h1, h2, h3 {
            text-align: center;
            color: #1877f2;
        }
        
        #prediction-form {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 600px) {
            #prediction-form {
                grid-template-columns: 1fr 1fr;
            }
        }

        .team-section, .match-odds-section {
            padding: 20px;
            border: 1px solid #dddfe2;
            border-radius: 8px;
            background-color: #f7f8fa;
        }
        
        .match-odds-section {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        input[type="number"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 12px;
            border-radius: 6px;
            border: 1px solid #dddfe2;
            box-sizing: border-box;
        }

        button {
            grid-column: 1 / -1;
            padding: 12px 20px;
            background: #1877f2;
            color: #ffffff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            transition: background-color 0.3s;
        }

        button:hover {
            background: #166fe5;
        }

        .hidden {
            display: none;
        }

        #results {
            margin-top: 25px;
            padding: 20px;
            border-radius: 8px;
            background-color: #ffffff;
            border: 1px solid #dddfe2;
        }
        
        #results p {
            font-size: 16px;
        }

        .advice-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #e7f3ff;
            border: 1px solid #1877f2;
            border-radius: 8px;
            text-align: center;
        }

        .advice-section h3 {
            margin-top: 0;
        }

        .advice-section p {
            font-size: 1.2em;
            font-weight: bold;
            color: #1c1e21;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš½ Football Match Predictor</h1>
        <form id="prediction-form">
            <div class="team-section">
                <h2>Home Team</h2>
                <label for="home_avg_score">Average Score:</label>
                <input type="number" step="0.01" id="home_avg_score" required value="1.29">

                <label for="home_avg_conceded">Average Conceded:</label>
                <input type="number" step="0.01" id="home_avg_conceded" required value="1.24">

                <label for="home_score_percentage">Scoring Percentage (%):</label>
                <input type="number" id="home_score_percentage" required value="71">

                <label for="home_cleansheet">Clean Sheet (%):</label>
                <input type="number" id="home_cleansheet" required value="33">

                <label for="home_difficulty">Difficulty (1-5):</label>
                <input type="number" id="home_difficulty" min="1" max="5" required value="4">
            </div>

            <div class="team-section">
                <h2>Away Team</h2>
                <label for="away_avg_score">Average Score:</label>
                <input type="number" step="0.01" id="away_avg_score" required value="1.5">

                <label for="away_avg_conceded">Average Conceded:</label>
                <input type="number" step="0.01" id="away_avg_conceded" required value="0.95">

                <label for="away_score_percentage">Scoring Percentage (%):</label>
                <input type="number" id="away_score_percentage" required value="73">

                <label for="away_cleansheet">Clean Sheet (%):</label>
                <input type="number" id="away_cleansheet" required value="50">

                <label for="away_difficulty">Difficulty (1-5):</label>
                <input type="number" id="away_difficulty" min="1" max="5" required value="4">
            </div>

            <div class="match-odds-section">
                <h2>Match Odds</h2>
                <label for="home_odds">Home Win Odds:</label>
                <input type="number" step="0.01" id="home_odds" required value="2.13">
                
                <label for="draw_odds">Draw Odds:</label>
                <input type="number" step="0.01" id="draw_odds" required value="3.3">
                
                <label for="away_odds">Away Win Odds:</label>
                <input type="number" step="0.01" id="away_odds" required value="3.25">
            </div>

            <button type="submit">ðŸ”® Predict Match</button>
        </form>
        <div id="results" class="hidden">
            </div>
    </div>
    <script>
        // --- Utility Functions ---
        const factorial = (n) => (n <= 1 ? 1 : n * factorial(n - 1));

        const poissonProb = (k, lam) => {
            if (lam <= 0) return k === 0 ? 1.0 : 0.0;
            return (Math.pow(lam, k) * Math.exp(-lam)) / factorial(k);
        };

        // --- Prediction Models ---
        function calculatePoisson(data) {
            const homeAttackStrength = data.home_avg_score * (6 - data.away_difficulty) / 5;
            const awayAttackStrength = data.away_avg_score * (6 - data.home_difficulty) / 5;
            const homeDefenseStrength = data.home_avg_conceded * (data.away_difficulty / 5);
            const awayDefenseStrength = data.away_avg_conceded * (data.home_difficulty / 5);

            const homeExpectedGoals = (homeAttackStrength + awayDefenseStrength) / 2;
            const awayExpectedGoals = (awayAttackStrength + homeDefenseStrength) / 2;
            
            let homeWin = 0, draw = 0, awayWin = 0;
            const maxGoals = 6;

            for (let h = 0; h <= maxGoals; h++) {
                for (let a = 0; a <= maxGoals; a++) {
                    const prob = poissonProb(h, homeExpectedGoals) * poissonProb(a, awayExpectedGoals);
                    if (h > a) homeWin += prob;
                    else if (h < a) awayWin += prob;
                    else draw += prob;
                }
            }
            return { home_win: homeWin, draw, away_win: awayWin, expected_goals: { home: homeExpectedGoals, away: awayExpectedGoals } };
        }

        function calculateFormBased(data) {
            let homeForm = data.home_score_percentage / 100.0;
            let awayForm = data.away_score_percentage / 100.0;
            const totalForm = homeForm + awayForm;

            let homeFormAdvantage = totalForm > 0 ? homeForm / totalForm : 0.5;
            let awayFormAdvantage = totalForm > 0 ? awayForm / totalForm : 0.5;

            homeFormAdvantage += 0.07; // Home advantage boost

            const formSum = homeFormAdvantage + awayFormAdvantage;
            homeFormAdvantage /= formSum;
            awayFormAdvantage /= formSum;
            
            const formDifference = Math.abs(homeFormAdvantage - awayFormAdvantage);
            let drawProb = Math.max(0.15, Math.min(0.45, 0.35 - (formDifference * 0.2)));

            const remainingProb = 1.0 - drawProb;
            return { home_win: homeFormAdvantage * remainingProb, draw: drawProb, away_win: awayFormAdvantage * remainingProb };
        }

        function calculateDefensiveStrength(data) {
            const homeDefenseRating = (data.home_cleansheet / 100.0) * (1 / Math.max(0.1, data.home_avg_conceded));
            const awayDefenseRating = (data.away_cleansheet / 100.0) * (1 / Math.max(0.1, data.away_avg_conceded));

            const homeAttackVsAwayDefense = data.home_avg_score / Math.max(0.1, data.away_avg_conceded);
            const awayAttackVsHomeDefense = data.away_avg_score / Math.max(0.1, data.home_avg_conceded);
            
            const totalAttackRatio = homeAttackVsAwayDefense + awayAttackVsHomeDefense;
            const homeAttackNorm = totalAttackRatio > 0 ? homeAttackVsAwayDefense / totalAttackRatio : 0.5;
            const awayAttackNorm = totalAttackRatio > 0 ? awayAttackVsHomeDefense / totalAttackRatio : 0.5;

            const avgDefenseStrength = (homeDefenseRating + awayDefenseRating) / 2;
            const drawBoost = Math.min(0.15, avgDefenseStrength * 0.3);
            const baseDraw = 0.25 + drawBoost;
            const remainingProb = 1.0 - baseDraw;

            return { home_win: homeAttackNorm * remainingProb, draw: baseDraw, away_win: awayAttackNorm * remainingProb };
        }
        
        function calculateMarketSentiment(data) {
            const homeImplied = 1 / data.home_odds;
            const drawImplied = 1 / data.draw_odds;
            const awayImplied = 1 / data.away_odds;
            const totalImplied = homeImplied + drawImplied + awayImplied;

            return {
                home_win: homeImplied / totalImplied,
                draw: drawImplied / totalImplied,
                away_win: awayImplied / totalImplied
            };
        }

        function calculateCompositeRating(data) {
            const homeQuality = (data.home_avg_score * 0.3) +
                                ((1 / Math.max(0.1, data.home_avg_conceded)) * 0.2) +
                                ((data.home_score_percentage / 100) * 0.25) +
                                ((data.home_cleansheet / 100) * 0.15) +
                                (((6 - data.home_difficulty) / 5) * 0.1);

            const awayQuality = (data.away_avg_score * 0.3) +
                                ((1 / Math.max(0.1, data.away_avg_conceded)) * 0.2) +
                                ((data.away_score_percentage / 100) * 0.25) +
                                ((data.away_cleansheet / 100) * 0.15) +
                                (((6 - data.away_difficulty) / 5) * 0.1);
            
            const qualityDiff = homeQuality - awayQuality;
            const qualitySum = homeQuality + awayQuality;
            
            const homeBaseProb = qualitySum > 0 ? 1 / (1 + Math.exp(-qualityDiff * 3)) : 0.5;
            const awayBaseProb = 1 - homeBaseProb;
            
            const contextFactor = Math.sqrt(homeQuality * awayQuality);
            let drawProb = Math.min(0.4, 0.2 + (contextFactor * 0.15));
            
            const remaining = 1.0 - drawProb;
            return {
                home_win: homeBaseProb * remaining,
                draw: drawProb,
                away_win: awayBaseProb * remaining,
                home_quality: homeQuality,
                away_quality: awayQuality
            };
        }

        // --- Main Prediction Logic ---
        document.getElementById('prediction-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const data = {
                home_avg_score: parseFloat(document.getElementById('home_avg_score').value),
                home_avg_conceded: parseFloat(document.getElementById('home_avg_conceded').value),
                home_score_percentage: parseFloat(document.getElementById('home_score_percentage').value),
                home_cleansheet: parseFloat(document.getElementById('home_cleansheet').value),
                home_difficulty: parseInt(document.getElementById('home_difficulty').value),
                away_avg_score: parseFloat(document.getElementById('away_avg_score').value),
                away_avg_conceded: parseFloat(document.getElementById('away_avg_conceded').value),
                away_score_percentage: parseFloat(document.getElementById('away_score_percentage').value),
                away_cleansheet: parseFloat(document.getElementById('away_cleansheet').value),
                away_difficulty: parseInt(document.getElementById('away_difficulty').value),
                home_odds: parseFloat(document.getElementById('home_odds').value),
                draw_odds: parseFloat(document.getElementById('draw_odds').value),
                away_odds: parseFloat(document.getElementById('away_odds').value),
            };

            const weights = {
                poisson: 0.25,
                form_based: 0.20,
                defensive_strength: 0.15,
                market_sentiment: 0.20,
                composite_rating: 0.20
            };

            // Calculate all model predictions
            const poissonPred = calculatePoisson(data);
            const formPred = calculateFormBased(data);
            const defensePred = calculateDefensiveStrength(data);
            const marketPred = calculateMarketSentiment(data);
            const compositePred = calculateCompositeRating(data);

            // Calculate final ensemble probabilities
            let finalHome = (poissonPred.home_win * weights.poisson) + (formPred.home_win * weights.form_based) + (defensePred.home_win * weights.defensive_strength) + (marketPred.home_win * weights.market_sentiment) + (compositePred.home_win * weights.composite_rating);
            let finalDraw = (poissonPred.draw * weights.poisson) + (formPred.draw * weights.form_based) + (defensePred.draw * weights.defensive_strength) + (marketPred.draw * weights.market_sentiment) + (compositePred.draw * weights.composite_rating);
            let finalAway = (poissonPred.away_win * weights.poisson) + (formPred.away_win * weights.form_based) + (defensePred.away_win * weights.defensive_strength) + (marketPred.away_win * weights.market_sentiment) + (compositePred.away_win * weights.composite_rating);
            
            const total = finalHome + finalDraw + finalAway;
            finalHome /= total;
            finalDraw /= total;
            finalAway /= total;

            const maxProb = Math.max(finalHome, finalDraw, finalAway);
            let predictedOutcome = "Away Win";
            if (maxProb === finalHome) predictedOutcome = "Home Win";
            else if (maxProb === finalDraw) predictedOutcome = "Draw";
            
            const probs = [finalHome, finalDraw, finalAway];
            const entropy = -probs.reduce((acc, p) => acc + p * Math.log(p + 1e-10), 0);
            const maxEntropy = Math.log(3);
            const confidence = 1 - (entropy / maxEntropy);
            
            // *** NEW WAGERING ADVICE LOGIC ***
            const final_probs = { home_win: finalHome, draw: finalDraw, away_win: finalAway };
            const aa_diff = formPred.away_win - final_probs.away_win;
            const hh_diff = formPred.home_win - final_probs.home_win;
            const dd_diff = formPred.draw - final_probs.draw;
            const d_diff = final_probs.draw - compositePred.draw;
            const a_diff = final_probs.away_win - compositePred.away_win;
            const h_diff = final_probs.home_win - compositePred.home_win;
            const h_hs = formPred.home_win - defensePred.home_win;
            const a_as = formPred.away_win - defensePred.away_win;

            const htotal = (marketPred.home_win + defensePred.home_win + formPred.home_win) / 3;
            const atotal = (marketPred.away_win + defensePred.away_win + formPred.away_win) / 3;
            const hh_adv = htotal / compositePred.home_win;
            const aa_adv = atotal / compositePred.away_win;
            const hh_adv_per = (hh_adv - aa_adv) * 100;
            const aa_adv_per = (aa_adv - hh_adv) * 100;

            const homie = h_diff > d_diff && dd_diff > hh_diff;
            const awayie = a_diff > d_diff && dd_diff > aa_diff;

            let bettingAdvice = '';
            const term1 = (hh_diff + a_diff) > h_diff;
            const term2 = (hh_diff + a_diff) > (((a_diff - aa_diff) - (h_diff - aa_diff)));
            const term3 = (aa_diff + h_diff) > a_diff;
            const term4 = (aa_diff + h_diff) > (((h_diff - hh_diff) - (a_diff - hh_diff)));

            if (h_hs > a_as && !(term1 && term2) && hh_adv_per > aa_adv_per && a_diff < d_diff && (term3 && term4)) {
                bettingAdvice = `Bet on --> Home Win (${homie})`;
            } else if (h_hs > a_as && !(term1 && term2) && hh_adv_per < aa_adv_per) {
                bettingAdvice = `Bet on --> Home Draw (${homie})`;
            } else if (h_hs < a_as && !(term3 && term4) && hh_adv_per < aa_adv_per && h_diff < d_diff && (term1 && term2)) {
                bettingAdvice = `Bet on --> Away Win (${awayie})`;
            } else if (h_hs < a_as && !(term3 && term4) && hh_adv_per > aa_adv_per) {
                bettingAdvice = `Bet on --> Away Draw (${awayie})`;
            } else {
                bettingAdvice = 'AVOID';
            }
            // *** END OF NEW LOGIC ***

            displayResults({
                predicted_outcome: predictedOutcome,
                probabilities: { home_win: finalHome, draw: finalDraw, away_win: finalAway },
                confidence: confidence,
                expected_goals: poissonPred.expected_goals,
                model_breakdown: { poisson: poissonPred, form_based: formPred, defensive_strength: defensePred, market_sentiment: marketPred, composite_rating: compositePred },
                team_quality_scores: { home: compositePred.home_quality, away: compositePred.away_quality }
            }, bettingAdvice);
        });

        function displayResults(prediction, advice) {
            const toPercent = (val) => (val * 100).toFixed(1) + '%';
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="advice-section">
                    <h3>Wagering Advice</h3>
                    <p>${advice}</p>
                </div>
                <h2>ðŸ“Š Prediction Analysis</h2>
                <p><strong>Predicted Outcome:</strong> ${prediction.predicted_outcome}</p>
                <p><strong>Confidence Level:</strong> ${toPercent(prediction.confidence)}</p>
                
                <h3>Final Probabilities:</h3>
                <p>Home Win: ${toPercent(prediction.probabilities.home_win)}</p>
                <p>Draw: ${toPercent(prediction.probabilities.draw)}</p>
                <p>Away Win: ${toPercent(prediction.probabilities.away_win)}</p>

                <h3>Expected Goals:</h3>
                <p>Home Team: ${prediction.expected_goals.home.toFixed(2)}</p>
                <p>Away Team: ${prediction.expected_goals.away.toFixed(2)}</p>

                <h3>Team Quality Scores:</h3>
                <p>Home Team: ${prediction.team_quality_scores.home.toFixed(3)}</p>
                <p>Away Team: ${prediction.team_quality_scores.away.toFixed(3)}</p>
                
                <h3>Model Breakdown:</h3>
                ${Object.entries(prediction.model_breakdown).map(([name, probs]) => `
                    <p><strong>${name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong> 
                    H: ${toPercent(probs.home_win)} | D: ${toPercent(probs.draw)} | A: ${toPercent(probs.away_win)}</p>
                `).join('')}
            `;
            resultsDiv.classList.remove('hidden');
        }
    </script>
</body>
</html>
